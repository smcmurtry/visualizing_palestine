<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
  <script src="queue.js"></script>
  // <script src="scroller.js"></script>
  <title>The Israeli ID System - Interactive</title>
  <meta name="description" content="The Israeli ID System - Interactive">
    <!-- <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/> -->
  <link rel="stylesheet" type="text/css" href="scroller.css"/>

</head>

<body>
<div class="container">
  <div id='graphic'>
    <div id='sections'>
      <section class="step">
        <div class="title">Jewish Israeli Citizens</div>
        Free to live throughout Israel and 60% of the occupied West Bank.
      </section>
      <section class="step">
        <div class="title">Palestinian Citizens of Israel</div>
        Barred from living in 68% of all towns in Israel by admissions committees.
      </section>
      <section class="step">
        <div class="title">East Jerusalem Palestinians</div>
        Access to most areas, but ID may be revoked if living outside of Jerusalem.
      </section>
      <section class="step">
        <div class="title">West Bank Palestinians</div>
        Barred from living in all but 40% of West Bank due to Israeli settler and military presence.
      </section>
      <section class="step">
        <div class="title">Gaza Strip Palestinians</div>
        Barred from living outside of Gaza since 2007.
      </section>
<!--       <section class="step">
        <div class="title">Palestinian Exiles</div>
        Barred from returning to live anywhere in Israel or Palestinian territory.
      </section> -->
    </div>
    <div id='vis'>
    </div>
    <div id="extra-space">
    </div>
  </div>
</div>
</body>


<script>
// using this tutorial: http://vallandingham.me/scroll_demo/
var data_path = "../data/";
var width = 600;
var height = 520;
var margin = {top:0, left:20, bottom:40, right:10};
var maps = [];

var path = d3.geo.path().projection(null);
var colours = ['green', 'red', 'orange', 'lightblue', 'grey'];

var svg = d3.select("#vis").append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g");

queue()
  .defer(d3.json, data_path + "background.json")
  .defer(d3.json, data_path + "water.json")
  .defer(d3.json, data_path + "map_1.json")
  .defer(d3.json, data_path + "map_2.json")
  .defer(d3.json, data_path + "map_3.json")
  .defer(d3.json, data_path + "map_4.json")
  .defer(d3.json, data_path + "map_5.json")
  .await(ready);

function ready(error, background, water, map_1, map_2, map_3, map_4, map_5) {
  if (error) throw error;


  var _background = topojson.feature(background, background.objects.background);
  var _water = topojson.feature(water, water.objects.water);

  var map_vars = [map_1, map_2, map_3, map_4, map_5];
  var map_fnames = ['map_1', 'map_2', 'map_3', 'map_4', 'map_5'];
  for (var i = 0; i < map_vars.length; i++) {
    var _map = topojson.feature(map_vars[i], map_vars[i].objects[map_fnames[i]]);
    maps.push(_map)
  };

  svg.append("g")
    .selectAll("path")
      .data(_background.features)
    .enter().append("path")
      .attr("class", "riding")
      .attr("d", path)
      .attr("fill", 'lightgrey');

  svg.append("g")
    .selectAll("path")
      .data(_water.features)
    .enter().append("path")
      .attr("class", "riding")
      .attr("d", path)
      .attr("fill", 'steelblue');

  initialize_zoom();

  function initialize_zoom() {
    var b = path.bounds(_background),
        s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1]))/2 ];

    svg.attr("transform", "translate(" + t + ")scale(" + s + ")");
  }

  var scrollVis = function() {
    var lastIndex = -1;
    var activeIndex = 0;

    var chart = function(selection) {
      selection.each(function(rawData) {
        setupSections();
      });
    };

    chart.activate = function(index) {
      activeIndex = index;
      var sign = (activeIndex - lastIndex) < 0 ? -1 : 1;
      var scrolledSections = d3.range(lastIndex + sign, activeIndex + sign, sign);
      scrolledSections.forEach(function(i) {
        console.log(i)

        d3.select('.access-layer')
          .remove();

        svg.append("g")
          .attr('class', 'access-layer')
          .selectAll("path")
            .data(maps[i].features)
          .enter().append("path")
            .attr("class", "riding")
            .attr("d", path)
            .attr("fill", 'red')//colours[i])
      });
      lastIndex = activeIndex;
    };
    return chart;
  }

  function display() {
    var plot = scrollVis();
    var scroll = scroller()
      .container(d3.select('#graphic'));
    scroll(d3.selectAll('.step'));
    scroll.on('active', function(index) {
      d3.selectAll('.step')
        .style('opacity',  function(d,i) { return i == index ? 1 : 0.1; });
      plot.activate(index);
    });
  }

  display();
}


</script>